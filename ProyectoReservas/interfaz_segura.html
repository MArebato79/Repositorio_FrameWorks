<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestor de Reservas - Autenticado</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; background-color: #f6f6f6; }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px;}
        button { margin-top: 5px; padding: 8px 15px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 4px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        input, select { margin: 3px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        pre { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        #estado-auth { padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .success { background-color: #e8f9e8; color: #27ae60; border: 1px solid #27ae60; }
        .error { background-color: #fcebeb; color: #c0392b; border: 1px solid #c0392b; }
    </style>
</head>
<body>

<h1>API de Reservas de Aulas (Acceso Seguro)</h1>

<div id="estado-auth">
    Estado de Autenticaci贸n: <strong id="token-status">No autenticado</strong>.
    <button onclick="logout()">Cerrar Sesi贸n</button>
</div>

<section>
    <h2> Autenticaci贸n</h2>
    <input id="authEmail" type="email" placeholder="Email">
    <input id="authPassword" type="password" placeholder="Contrase帽a">
    <button onclick="login()">Login</button>
    <button onclick="register('profesor')">Registrar Profesor</button>
    <button onclick="register('admin')">Registrar Admin</button>
</section>

<section>
    <h2> Aulas</h2>
    <button onclick="getAulas()">Ver todas las aulas (GET /aulas)</button><br>
    <input id="idAulaGet" type="number" placeholder="ID Aula (ej: 1)">
    <button onclick="getAulaById()">Ver Aula por ID</button>
    <hr>
    <h3>Crear Aula (POST /aulas)</h3>
    <input id="nombreAula" placeholder="Nombre (ej: Lab F铆s.)">
    <input id="capacidadAula" type="number" placeholder="Capacidad (ej: 30)">
    <label><input id="ordenadoresAula" type="checkbox"> Aula de ordenadores</label>
    <input id="numOrdenadoresAula" type="number" placeholder="N潞 ordenadores (ej: 15)">
    <button onclick="crearAula()">Crear Aula</button>
</section>

<section>
    <h2> Horarios</h2>
    <button onclick="getHorarios()">Ver todos los horarios (GET /horarios)</button><br>
</section>

<section>
    <h2> Reservas</h2>
    <button onclick="getReservas()">Ver todas las reservas (GET /reservas)</button><br>
    <hr>
    <h3>Crear Reserva (POST /reservas)</h3>
    <input id="fechaReserva" type="date">
    <input id="motivoReserva" placeholder="Motivo">
    <input id="asistentesReserva" type="number" placeholder="Asistentes">
    <input id="idAulaReserva" type="number" placeholder="ID Aula (ej: 1)">
    <input id="idHorarioReserva" type="number" placeholder="ID Horario (ej: 1)">
    <input id="idUsuarioReserva" type="number" placeholder="ID Usuario (ej: 1)">
    <button onclick="crearReserva()">Crear Reserva</button>
</section>

<section>
    <h2>Ь Resultado</h2>
    <pre id="output"></pre>
</section>

<script>
    const API = 'http://localhost:8080';
    let currentToken = localStorage.getItem('jwtToken');

    // --- UTILITIES ---

    function updateAuthStatus() {
        const statusElement = document.getElementById('token-status');
        const authDiv = document.getElementById('estado-auth');
        if (currentToken) {
            statusElement.textContent = 'Autenticado (Token presente)';
            authDiv.className = 'success';
        } else {
            statusElement.textContent = 'No autenticado';
            authDiv.className = 'error';
        }
    }

    function mostrar(data) {
        document.getElementById('output').textContent = JSON.stringify(data, null, 2);
    }

    /**
     * Funci贸n gen茅rica para peticiones a la API con el token JWT.
     * @param {string} endpoint - La ruta de la API (ej: '/aulas').
     * @param {string} method - El m茅todo HTTP.
     * @param {object|null} bodyData - El cuerpo de la petici贸n (para POST/PUT).
     */
    async function authenticatedFetch(endpoint, method = 'GET', bodyData = null) {
        const headers = {
            'Content-Type': 'application/json',
        };

        // Si tenemos un token, lo adjuntamos
        if (currentToken) {
            headers['Authorization'] = `Bearer ${currentToken}`;
        }

        const config = {
            method: method,
            headers: headers,
        };

        if (bodyData) {
            config.body = JSON.stringify(bodyData);
        }

        const res = await fetch(`${API}${endpoint}`, config);

        // Si la respuesta es 401 (Unauthorized), forzamos el logout para limpiar el token
        if (res.status === 401) {
            alert('Sesi贸n expirada o no autorizada. Por favor, inicie sesi贸n de nuevo.');
            logout();
            return null; // Devuelve null si falla la autenticaci贸n
        }

        // Si la respuesta es 204 No Content (como en DELETE), devolvemos un mensaje
        if (res.status === 204) {
            return { message: `${method} ${endpoint} exitoso: 204 No Content` };
        }

        // Para cualquier otra respuesta, intentamos leer el JSON
        try {
            return await res.json();
        } catch (e) {
            // Manejar caso donde el cuerpo est谩 vac铆o o no es JSON (ej: 200 OK vac铆o)
            return { message: `${method} ${endpoint} exitoso: Sin contenido de respuesta.` };
        }
    }

    // --- AUTHENTICATION FUNCTIONS ---

    async function login() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const data = await authenticatedFetch('/auth/login', 'POST', { email, password });

        if (data && data.token) {
            currentToken = data.token;
            localStorage.setItem('jwtToken', currentToken);
            updateAuthStatus();
            mostrar({ message: "Login exitoso. Token almacenado.", token: data.token });
        } else if (data) {
            mostrar(data); // Muestra el error (ej: Credenciales incorrectas)
        }
    }

    async function register(role) {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        const endpoint = role === 'admin' ? '/auth/register/admin' : '/auth/register';
        const data = await authenticatedFetch(endpoint, 'POST', { email, password });
        mostrar(data);
    }

    function logout() {
        currentToken = null;
        localStorage.removeItem('jwtToken');
        updateAuthStatus();
        mostrar({ message: "Sesi贸n cerrada. Token eliminado." });
    }

    // --- CRUD AULA (Requires Auth) ---

    async function getAulas() {
        const data = await authenticatedFetch('/aulas');
        mostrar(data);
    }

    async function getAulaById() {
        const id = document.getElementById('idAulaGet').value;
        const data = await authenticatedFetch(`/aulas/${id}`);
        mostrar(data);
    }

    async function crearAula() {
        const aula = {
            nombre: document.getElementById('nombreAula').value,
            capacidad: +document.getElementById('capacidadAula').value,
            esDeOrdenadores: document.getElementById('ordenadoresAula').checked,
            numeroOrdenadores: +document.getElementById('numOrdenadoresAula').value
        };
        const data = await authenticatedFetch('/aulas', 'POST', aula);
        mostrar(data);
    }

    // --- CRUD HORARIO (Requires Auth) ---

    async function getHorarios() {
        const data = await authenticatedFetch('/horarios');
        mostrar(data);
    }

    // --- CRUD RESERVA (Requires Auth) ---

    async function getReservas() {
        const data = await authenticatedFetch('/reservas');
        mostrar(data);
    }

    async function crearReserva() {
        // Debes completar el Request DTO en el backend para incluir el usuarioId
        // Por ahora, usamos el esquema simplificado de tu ReservaController para el cuerpo de la reserva
        const reserva = {
            fecha: document.getElementById('fechaReserva').value, // '2025-11-20'
            motivo: document.getElementById('motivoReserva').value,
            numeroAsistentes: +document.getElementById('asistentesReserva').value,
            // NOTA: El ServicioReserva espera Longs para los IDs, no objetos Aula/Horario,
            // as铆 que el Request DTO debe reflejar ReservaRequest.java
            // Usamos un Request DTO completo (aunque los campos se extraen del servicio):
            fechaReserva: document.getElementById('fechaReserva').value,
            aulaId: +document.getElementById('idAulaReserva').value,
            horarioId: +document.getElementById('idHorarioReserva').value,
            usuarioId: +document.getElementById('idUsuarioReserva').value // Asumiendo que el usuario logueado es el ID 1
        };

        const data = await authenticatedFetch('/reservas', 'POST', reserva);
        mostrar(data);
    }

    // Inicializar el estado al cargar la p谩gina
    updateAuthStatus();
</script>
</body>
</html>